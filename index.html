<script>
  let deferredPrompt = null;
  const installButton = document.getElementById('install-button');

  /* =========================
     SPLASH
  ========================= */
  window.addEventListener("load", function () {
    setTimeout(function () {
      const splash = document.getElementById("splash-screen");
      splash.style.opacity = "0";
      setTimeout(function () {
        splash.style.display = "none";
      }, 400);
    }, 3000);
  });

  /* =========================
     INSTALACIÓN PWA
  ========================= */
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;

    if (installButton) {
      installButton.style.display = 'block';
    }
  });

  if (installButton) {
    installButton.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        installButton.style.display = 'none';
      }
    });
  }

  window.addEventListener('appinstalled', () => {
    if (installButton) {
      installButton.style.display = 'none';
    }
  });

  /* =========================
     SERVICE WORKER + ACTUALIZACIÓN AUTOMÁTICA
  ========================= */
  if ('serviceWorker' in navigator) {

    navigator.serviceWorker.register('/APP-presupuesto-V3/service-worker.js')
      .then((registration) => {

        console.log("Service Worker registrado correctamente");

        // Si ya hay uno esperando
        if (registration.waiting) {
          registration.waiting.postMessage({ type: 'SKIP_WAITING' });
        }

        // Detectar nueva versión
        registration.onupdatefound = () => {

          const newWorker = registration.installing;

          if (!newWorker) return;

          newWorker.onstatechange = () => {

            if (newWorker.state === 'installed') {

              if (navigator.serviceWorker.controller) {
                console.log("Nueva versión detectada");

                newWorker.postMessage({ type: 'SKIP_WAITING' });
              }
            }
          };
        };
      })
      .catch(error => {
        console.error("Error registrando SW:", error);
      });

    // Cuando el nuevo SW toma control
    navigator.serviceWorker.addEventListener('controllerchange', () => {
      console.log("Nueva versión activada");
      window.location.reload();
    });
  }
</script>
